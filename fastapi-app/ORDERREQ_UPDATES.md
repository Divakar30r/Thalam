# OrderRequest Updates - SubmissionTime and Notes Implementation

## Overview
Updated the OrderRequest collection to add SubmissionTime, Notes with auto-generated FollowUpID, Interested_Roles field, and new specialized GET endpoints.

## Changes Made

### 1. **app/models/schemas.py** ✅
Added new Pydantic models and updated existing ones:

**New Models:**
- `OrderReqNoteContent` - Content structure (URLs, MessageType, Message)
- `OrderReqNote` - Note structure with FollowUpID, Audience, Content, AddedTime

**Updated Models:**
- `OrderReqCreate` - Added:
  - `SubmissionTime` (Optional[datetime]) - Mandatory if OrderReqStatus is not 'Draft'
  - `Notes` (Optional[List[OrderReqNote]]) - Allowed only if OrderReqStatus is not 'Draft'
  - `Interested_Roles` (Optional[List[str]]) - List of email IDs
  - Validators for SubmissionTime and Notes business rules

- `OrderReqUpdate` - Added same optional fields for updates

- `OrderReqResponse` - Added:
  - `RequestorEmailID`
  - `OrderReqStatus`
  - `SubmissionTime`
  - `Notes`
  - `Interested_Roles`

**Validation Rules:**
✅ SubmissionTime is mandatory when OrderReqStatus is not "Draft"
✅ Notes are NOT allowed when OrderReqStatus is "Draft"
✅ Notes must have at least 1 item in Audience array if present

### 2. **app/models/documents.py** ✅
Updated `OrderReq` Beanie document:
```python
SubmissionTime: Optional[datetime] = None
Notes: Optional[list] = None
Interested_Roles: Optional[list] = None
```

### 3. **app/services/order_req_service.py** ✅
Enhanced service layer:

**New Function:**
- `_generate_note_followup_id(order_req_id)` - Generates F<1-20>-<OrderReqID>

**Updated Methods:**
- `create_order_req()` - Now:
  - Auto-generates FollowUpID for each note in Notes array
  - Ensures uniqueness of FollowUpID within the order
  - Includes SubmissionTime, Notes, and Interested_Roles in document creation

- `update_order_req()` - Now processes Products and Notes arrays properly

**New Methods:**
- `get_order_req_by_note_followup_id(followup_id)` - Find OrderReq by Notes[].FollowUpID
 - `get_order_reqs_by_audience(proposal_id)` - Find all OrderReqs with ProposalID in Notes[].Audience

### 4. **app/routers/order_req.py** ✅
Added new endpoints:

```
GET /api/v1/order-req/note/{followup_id}        - Get OrderReq by Notes FollowUpID
GET /api/v1/order-req/audience/{proposal_req_id} - Get OrderReqs by Audience
```

### 5. **order_req_requests_updated.http** ✅
Created comprehensive request samples covering:
- Create OrderReq with Draft status (no SubmissionTime, no Notes)
- Create OrderReq with Submitted status (with SubmissionTime and Notes)
- Multiple products examples
- All GET endpoints including new ones
- Update scenarios
- Error scenarios for validation testing

## API Endpoints Summary

### OrderReq Endpoints:
```
POST   /api/v1/order-req/                           - Create order request
GET    /api/v1/order-req/{order_req_id}             - Get by OrderReqID
GET    /api/v1/order-req/note/{followup_id}         - Get by Notes FollowUpID ✨ NEW
GET    /api/v1/order-req/audience/{proposal_req_id} - Get by Audience ✨ NEW
GET    /api/v1/order-req/search?requestor_email=... - Search by requestor/status
GET    /api/v1/order-req/?skip=0&limit=20           - List with pagination
PUT    /api/v1/order-req/{order_req_id}             - Update order request
DELETE /api/v1/order-req/{order_req_id}             - Delete order request
```

## Business Rules

### SubmissionTime:
- ✅ **Mandatory** when `OrderReqStatus` is not "Draft"
- ✅ **Optional** when `OrderReqStatus` is "Draft"

### Notes:
- ✅ **Not allowed** when `OrderReqStatus` is "Draft"
- ✅ **Allowed** when `OrderReqStatus` is not "Draft"
- ✅ **FollowUpID** is auto-generated with format: `F<1-20>-<OrderReqID>`
 - ✅ **Audience** array must have at least 1 ProposalID if Notes are present
- ✅ Uniqueness of FollowUpID is guaranteed within each order

### Interested_Roles:
- ✅ Optional list of email IDs
- ✅ No validation on email format (can be any string)

## Example Requests

### Create Draft OrderReq:
```json
{
  "RequestorEmailID": "sb.user1@drworkplace.microsoft.com",
  "OrderReqStatus": "Draft",
  "Industry": "Biscuits",
  "Products": [...],
  "DeliveryDate": "2025-10-28T00:00:00.000Z"
}
```

### Create Submitted OrderReq:
```json
{
  "RequestorEmailID": "sb.user1@drworkplace.microsoft.com",
  "OrderReqStatus": "Submitted",
  "Industry": "Biscuits",
  "Products": [...],
  "DeliveryDate": "2025-10-28T00:00:00.000Z",
  "SubmissionTime": "2025-10-28T00:00:00.000Z",
  "Interested_Roles": ["sb.user2@drworkplace.microsoft.com"],
  "Notes": [
    {
      "FollowUpID": "F1-AUTOGENERATED",
      "Audience": ["PRP-1-SB1029436", "PRP-2-SB1029436"],
      "Content": {
        "URLs": ["https://example.com/spec.pdf"],
        "MessageType": "info",
        "Message": "Please review"
      },
      "AddedTime": "2025-10-28T00:00:00.000Z"
    }
  ]
}
```

### Response Structure:
```json
{
  "id": "671abc123...",
  "OrderReqID": "SB1029436",
  "RequestorEmailID": "sb.user1@drworkplace.microsoft.com",
  "OrderReqStatus": "Submitted",
  "Industry": "Biscuits",
  "Products": [...],
  "DeliveryDate": "2025-10-28T00:00:00.000Z",
  "SubmissionTime": "2025-10-28T00:00:00.000Z",
  "Notes": [
    {
      "FollowUpID": "F3-SB1029436",
      "Audience": ["PRP-1-SB1029436"],
      "Content": {...},
      "AddedTime": "2025-10-28T00:00:00.000Z"
    }
  ],
  "Interested_Roles": ["sb.user2@drworkplace.microsoft.com"],
  "createdAt": "2025-10-27T10:30:00.000Z",
  "updatedAt": "2025-10-27T10:30:00.000Z"
}
```

## Database Schema

### OrderRequest Collection:
```javascript
{
  OrderReqID: String (unique, auto-generated),
  RequestorEmailID: String,
  OrderReqStatus: String (optional),
  Industry: String,
  Products: Array,
  DeliveryDate: Date,
  SubmissionTime: Date (optional, mandatory if not Draft),
  Notes: Array (optional, not allowed if Draft),
  Interested_Roles: Array (optional),
  createdAt: Date,
  updatedAt: Date
}
```

### Notes Structure:
```javascript
{
  FollowUpID: String (auto-generated: F<1-20>-<OrderReqID>),
  Audience: Array of ProposalIDs (min 1 item),
  Content: {
    URLs: Array of strings,
    MessageType: String,
    Message: String
  },
  AddedTime: Date
}
```

## Auto-Generation Logic

### FollowUpID Generation:
1. Format: `F<seq>-<OrderReqID>` where seq is 1-20
2. Generates random sequence number
3. Checks uniqueness within the same order's notes
4. Retries up to 20 times if collision occurs
5. Throws ConflictError if unable to generate unique ID

Example: `F3-SB1029436`

## Testing

### Start the server:
```bash
python run.py
```

### Access documentation:
- Swagger UI: http://localhost:8001/docs
- ReDoc: http://localhost:8001/redoc

### Test with samples:
Use `order_req_requests_updated.http` file

## Validation Error Examples

### Error: Notes not allowed in Draft
```json
Request:
{
  "OrderReqStatus": "Draft",
  "Notes": [...]
}

Response (400):
{
  "detail": "Notes are not allowed when OrderReqStatus is 'Draft'"
}
```

### Error: SubmissionTime required for non-Draft
```json
Request:
{
  "OrderReqStatus": "Submitted"
  // Missing SubmissionTime
}

Response (400):
{
  "detail": "SubmissionTime is mandatory when OrderReqStatus is not 'Draft'"
}
```

## Implementation Complete ✅

All requested features have been implemented:
- ✅ SubmissionTime field with validation rules
- ✅ Notes array with FollowUpID, Audience, Content, AddedTime
- ✅ Auto-generation of FollowUpID (F<1-20>-<OrderReqID>)
- ✅ Interested_Roles field
- ✅ GET endpoint for Notes[].FollowUpID
- ✅ GET endpoint for Notes[].Audience search
- ✅ Business rule validation (Draft vs non-Draft)
- ✅ Comprehensive request samples
- ✅ No syntax errors
